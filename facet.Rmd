---
title: "facet"
author: "Martin S. Bjørnerem"
date: "9 desember 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(readxl)
library(plotly) #bruker candle_stick?
library(lubridate)
library(tidyquant)
library(mosaic)
library(tsibble)
```

## Vårt prosjekt: Bitcoin og aksjemarkeder

###Introduksjon
Hva vi ønsker å gjøre, hvordan, hvilke data, innhentingsmetoder, utvikling i oppgaven underveis.


Vi ønsker å undersøke om prisutviklingen på bitcoin er relatert til kursene på verdens aksjemarkeder. Vi har hentet daglig data for bitcoin i USD (BTC/USD) og s&p500 så langt bak i tid som mulig. Siden BTC kan kjøpes og selges hele uka, også i helgene, mens børsnoterte aksjer kun handles mandag-fredag.Stolpediagrammet nedenfor viser gjennomsnitts- og median-pris for bitcoin fordelt på de ulike ukedagene. Ettersom forskjellene er minimale har vi valgt å fjerne observasjoner lørdager og søndager slik at vi kan "matche" datasettene. I en større oppgave vil det være nødvendig å foreta en hypotesetest om prisen for bitcoin i helgene er signifikant forskjellig fra ukedagene. En alternativ løsning kunne vært å omgjøre prisene og aksjekursene til ukentlig data.

### Første blikk/intrykk av bitcoin data

```{r data}
btc <- read_csv("data/BTC_USD Bitfinex Historical Data.csv", 
            col_types = cols(Date = col_date(format = "%b %d, %Y"), 
                                            Price = col_number())) #kan oppdateres

btc <- btc %>%
  select(Date, Price) %>%
  rename(BTC = "Price")

summary(btc)

btc %>%
  filter(BTC==0)

btc <- btc %>%
  filter(BTC>0)

day_mean <- btc %>%
  group_by(day = weekdays(Date)) %>%
  summarise(mean = mean(BTC), median = median(BTC))

day_mean$day <- factor(day_mean$day, levels = c("mandag", "tirsdag", "onsdag", "torsdag",  "fredag", "lørdag", "søndag"))

day_mean

day_mean <- day_mean %>%
  gather(key = stat, value = value, -day)
  
  ggplot(day_mean, aes(x=day, y=value, fill = stat)) +
  geom_bar(stat = "identity", position = "dodge")

  
### s&p 500
  
  
sp500 <- read_csv("data/^GSPC.csv")
#S&P 500 er en indeks som består av de 500 største selskapene på NYSE (?)

sp500 <- sp500 %>%  
  select(Date, Close) %>%
  rename(SP = "Close")

summary(sp500)


###shanghai

shanghai <- read_csv("data/Shanghai Composite Historical Data.csv", 
            col_types = cols(Date = col_date(format = "%b %d, %Y"), 
                                            Price = col_number()))

shanghai <- shanghai %>%
  select(Date, Price) %>%
  rename(SH = "Price")

summary(shanghai)

ukedager <- btc %>%
  inner_join(sp500, by = "Date") %>%
  inner_join(shanghai, by = "Date")

ukedager_long <- ukedager %>%
  gather(index, verdi, -Date, -BTC)

ukedager_long

```

##S&P 500 og BTC

```{r first look, fig.height=10, fig.width= 15}

ggplot(ukedager_long, aes(x=BTC, y=verdi)) +
  geom_point() +
  facet_wrap(~index)

ggplot(ukedager_long, aes(x=BTC, y=verdi)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~index)

```

For S&P 500: Vi ser at variablene er relaterte, men at forholdet ikke er lineært. En lineær modell vil derfor ikke passe for tidsintervallet. S&P 500 mot log(BTC) gir en mye bedre fit. Vi kan lage en lineær modell for S&P som utrykk av logaritmeverdiene av bitcoin. I enkelte ggplot-grafer er en svært lav alpha benyttet for å vise den ekstreme overplottingen i nedre venstre hjørne.  

For Shanghai Composite: Ser vi at variablene ikke er relatert, bort sett fra en periode midtveis. Hvor det ser ut til å være en korrelasjon, dette er sannsynligvis er en periode i 2014 hvor begge to gikk mye opp samtidig.   



```{r, fig.height=10, fig.width= 15}
logfit <- lm(SP~log(BTC), data = ukedager)
summary(logfit)
plotModel(logfit)

cor(ukedager$SP, log(ukedager$BTC))
#cor = 0.94

 ukedager <- ukedager %>%
  mutate(log_BTC = log(BTC))
 
  ukedager_long <- ukedager_long %>%
  mutate(log_BTC = log(BTC))
 
ggplot(ukedager_long, aes(x=log_BTC, y=verdi)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, col = "red") +
  labs(x = "log(BTC)") +
  facet_wrap(~index)

```


Positiv korrelasjon innebærer at når den ene variabelen øker, øker også den andre. Styrken i forholdet er lik korrelasjonskoeffisienten, som er 0.94. Korrelasjonen er svært sterk og ikke langt unna perfekt. Ved perfekt korrelasjon er koeffisienten?? lik 1.

Hva sier regresjonsmodellen?
R-squared er 0.89. 89% av variasjon i S&P 500 kan forklares av variasjon i log(BTC). For lineære modeller med kun en uavhengig variabel er verdien lik korrelasjonskoeffesienten opphøyet i 2. 

Vi er interessert i å se hvordan forholdet og korrelasjonen mellom S&P 500 og log av BTC har utviklet seg over tid. 

```{r, fig.height=10, fig.width= 15}
ukedager_years_l <- ukedager_long %>%
  mutate(year = substr((Date), start = 1, stop = 4))

ukedager_years_l$year <- as.factor(ukedager_years_l$year)

ggplot(ukedager_years_l, aes(x = log_BTC, y = verdi, col = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black", linetype = "dashed") +
  facet_wrap(~index)

ggplot(ukedager_years_l, aes(x = log_BTC, y = verdi, col = year)) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~index)

```

Legger til farge for ulike år for å vise utvikling i korrelasjon over tid.

For USA:
I den andre grafen har hvert år fått en regresjonslinje fra egen lineær modell. Fra grafen ser vi at regresjonslinjene har negativt stigningstall i to årstall, 2014 og 2018. Begge de to årene opplevde bitcoin at "bobla sprakk", uten at børsindeksene falt. 

For Kina: 
Vi ser at spredningen i data og avstanden fra regresjnslinjen tyder på veldig stor volatilitet, noe som stemmer overrens med virkeligheten. Shanghai børsen nådde klimax i 2015 og har siden synket over 50%. Stort sette alle datapunktene for 2015 ligger overnfor regresjonslinjen, og i 2018 ser vi at flesteparten av dataen ligger under linjen noe som stemmer overrens med at Bitcoin har falt veldig i verdi i 2018. 


#Glidende korrelasjon
Vi har benyttet 200 dagers glidende korrelasjon. Korrelasjonen på 200 dager flyttes mot høyre. Enhver observasjonen er et resultat av de siste 200 dagene. De 200 første observasjonene "forsvinner" dermed da de ikke har en verdi.

```{r}
rolling_cor <- ukedager %>% 
  mutate(cor_200 = slide2(SP, log_BTC, cor, .size = 200, .align = "right")) %>% 
  unnest() %>%
  na.omit()

mean.cor <- cor(ukedager$SP,ukedager$log_BTC)
mean.200.cor <- mean(rolling_cor$cor_200)
mean.cor
mean.200.cor

min.200.cor <- min(rolling_cor$cor_200)
max.200.cor <- max(rolling_cor$cor_200)


ggplot(data = rolling_cor) + geom_line(aes(x = Date, y = cor_200)) + 
  geom_hline(yintercept=mean.cor, linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=mean.200.cor, linetype="dashed", color = "blue", size=1)
```

For USA: Korrelasjonen varierer sterkt i løpet av bitcoins levetid. Med 200-dagers glidende korrelasjon blir utviklingen jevnere enn ved f.eks 100- eller 50- dagers intervaller. Grafen viser at korrelasjonen mellom den amerikanske indeksen og bitcoin har vært svært høy over to lengre perioder (2013 til midten av 2014 og 2017 til midten av 2018). I perioden mellom var den glidende korrelasjonen ned mot -0.7. I denne perioden var det stor nedgang i prisen på bitcoin, mens den amerikanske børsindeksen fortsatte å øke. I andre halvdel av 2018 sank korrelasjonen igjen ned til -0.5. Gjennomsnittet for 200-dagers korrelasjonene er likevel positivt og ligger på 0.42.

Grafen viser den samme utviklingen som de fargerike regresjonslinjene fra forrige figur. I 2014 og 2018 synker korrelasjonen, i 2015 er den positiv, men svak. De resterende årene er korrelasjon positiv og sterk.

```{r}

rolling_cor <- ukedager %>% 
  mutate(cor_200 = slide2(SH, log_BTC, cor, .size = 200, .align = "right")) %>% 
  unnest() %>%
  na.omit()

mean.cor.c <- cor(ukedager$SH,ukedager$log_BTC)
mean.200.cor.c <- mean(rolling_cor$cor_200)
mean.cor.c
mean.200.cor.c

min.200.cor.c <- min(rolling_cor$cor_200)
max.200.cor.c <- max(rolling_cor$cor_200)


ggplot(data = rolling_cor) + geom_line(aes(x = Date, y = cor_200)) + 
  geom_hline(yintercept=mean.cor.c, linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=mean.200.cor.c, linetype="dashed", color = "blue", size=1)
```
Den kinesiske glidene korrelasjon skille seg fra den Amerikanske ved at den er mye mer negativ. Dette må nok ses i sammenheng med utviklingen i markede. I 2015 ser vi i at korrelasjon er på nesten -1.  Det er på samme tidspunkt som Shanghai børsen når sin all time high og Bitcoin er på sin bunn etter at 2014 bobblen sprakk.  

Hvordan er den kinesiske glidende korrelasjon?
Stemmer den intuitivt med fargelinjene?
Hvilken situasjon forklarer topp og bunn?


Den gjennomsnittlige korrelasjonen er høyere enn gjennomsnittet av den 200-dagers glidende korrelasjonen. Dette gjelder både for den amerikanske og kinesiske indeksen.


##Multippel regresjonsmodell:

```{r multiple data}

### Oil wti 

oilwti <- read_csv("data/Crude Oil WTI Futures Historical Data.csv", 
                   col_types = cols(Date = col_date(format = "%b %d, %Y")))

oilwti <- oilwti %>%
  select(Date, Price) %>%
  rename(oil = "Price")

#### USA 3m Bond rate

usa3m <- read_csv("data/United States 3-Month Bond Yield Historical Data.csv", 
                  col_types = cols(Date = col_date(format = "%b %d, %Y")))

usa3m <- usa3m %>%
  select(Date, Price) %>%
  rename(us3m = "Price")

china_1y <- read_csv("data/China 1-Year Bond Yield Historical Data.csv", 
                      col_types = cols(Date = col_date(format = "%b %d, %Y"))) 

china_1y <- china_1y %>%
  select(Date, Price) %>%
  rename(ch1y = "Price")


#### Felles datasett 


multi <- china_1y %>%
  inner_join(oilwti, by = "Date") %>%
  inner_join(usa3m, by = "Date") %>%
  inner_join(shanghai, by = "Date") %>%
  inner_join(sp500, by = "Date") %>%
  inner_join(btc, by = "Date")


head(multi)

```

##For USA:
```{r, echo = TRUE}
multifit <- lm(formula = SP ~ oil + us3m + log(BTC), data = multi)
summary(multifit)
```


En multippel regresjonsanalyse av S&P 500 med amerikansk oljepris, rente på 3-måneders amerikanske statsobligasjoner og transformerte verdier av bitcoin som uavhengige variabler. R-squared for modellen er 0.94, dette er høyere enn ved bitcoin som eneste faktor. Når vi legger til olje og statsobligasjoner øker prediksjonsverdien til modellen med 0.05 (0.94-0.89).

##Oppsummering av S&P 500 og BTC
S&P 500 er sterkt korrelert med BTC. Transformering av bitcoinprisen til logaritmeverdier viser en sterk og positiv korrelasjon. 

##For Kina:

```{r}

multifit.c <- lm(formula = SH ~ oil + ch1y + log(BTC), data = multi)
summary(multifit.c)
```

Hva viser modellen? Endring fra enkel regresjonsmodell (kun BTC)? (Finner ikke den enkle)

Multiple R-squared er mye lavere for det kinesiske markede (0.5979) enn for det amerikanske (0.9438). Detter er sannaynligvis tilfelledigheter siden det kinesiske markedet har hatt negativ utvikling etter 2015 mens det amerikanske og bitcoin har hatt en sammenfallende positiv utviling hvis man ser på perioden under et. 

Svakheten i dataen skal vi komme illustrere videre i oppgaven ved å analysere samme data men over ulike tidshoisonter. Siden bitcoin dataen er over en relativ kort tidshorisont, og hele perioden sammenfaller med bullmarket etter finanaskrisen kan dataen får en urelatert positiv korrelasjon.   


```{r}
multi_cor  <- multi%>% 
  select(ch1y, oil, us3m, BTC, SP, SH)

res <- cor(multi_cor)
round(res, 2)

corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```
Her ser vi en korrelasjons matrix på viktige faktorer i finansmarkedene i USA og Kina. Vi har valgt å tatt med USA 3 month treassury bonds, og Kinesiske 1 year bonds. Disse blir ansett for å være benchmarken rente for risikofri kapital, og er dermed viktig i verdsettingen av eiendeler.  

Her ser vi oljeprisen negative utvikling på finansmarkedene. Det skjer ved at en økning i pris på en viktig innsatsfaktor (olje) prises inn markede ved å redusere akjskurser siden økt oljepris redusert fri egenkapital hos bedrifter.  

```{r}

multi_u <- china_1y %>%
  inner_join(oilwti, by = "Date") %>%
  inner_join(usa3m, by = "Date") %>%
  inner_join(shanghai, by = "Date") %>%
  inner_join(sp500, by = "Date")

multi_u_cor  <- multi_u%>% 
  select(ch1y, oil, us3m, SP, SH)

res2 <- cor(multi_u_cor)
round(res, 2)

corrplot(res2, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
 

```

Vi ser her at korrelasjonene er mye svakere når tidshorisonten øker. Vi ønsker dermed å se på differansen i korrelasjon når vi har forskjellige lenge på dataen ved å lage en differanse korrelasjon matrix.  

```{r}


res3 <- res[c(1, 2, 3, 5, 6), c(1, 2, 3, 5, 6)]


res4 <- res3 - res2

res4
```

Her ser vi en  korrelasjon differanse matrix når vi analyserer korrelasjoner i tidsperiodene 2012-2018 og 2002-2018. Differanse matrixen kunne dessverre ikke vises grafisk siden enkelte differanser i korrelasjon var større enn 1  eller -1 og korrelasjoner kan kun utrykkes innenfor det intervallet. 

#Konklusjon 

Ut fra dataen tyder det på at det amrikanske markedet er tetter knyttet opp mot bitcoin. USA er også verdens største øknomi og USAs BNP er 40% større en Kinas. Da er det kanskje ikke så unaturlig at utvillingen i det amerikanske markede påvirker Bitcoin mer enn Kinas.     


##Svakheter/utfordringer

Utfordringen i vår analyse er tidshorisont. Datasette til bitcoin strekker seg tilbake til 2012, fordi det var da det startet å bli handlet.   



