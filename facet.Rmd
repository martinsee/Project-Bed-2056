---
title: "facet"
author: "Martin S. Bjørnerem (X) og Chris A. Stokvik (1) "
date: "9 desember 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(readxl)
library(lubridate)
library(mosaic)
library(tsibble)
library(corrplot)
```

## Vårt prosjekt: Bitcoin og aksjemarkeder

###Introduksjon
Hva vi ønsker å gjøre, hvordan, hvilke data, innhentingsmetoder, utvikling i oppgaven underveis. Slettelinje?? 


Vi ønsker å undersøke om prisutviklingen på bitcoin er relatert til kursene på verdens aksjemarkeder. Vi har hentet daglig data for bitcoin i USD (BTC/USD) og s&p500 så langt bak i tid som mulig. BTC kan kjøpes og selges hele uka, også i helgene, mens børsnoterte aksjer kun handles mandag-fredag måtte vi vurdere om vi kunne kutte ut helge dataen. Stolpediagrammet nedenfor viser gjennomsnitts- og median-pris for bitcoin fordelt på de ulike ukedagene. Ettersom forskjellene er minimale har vi valgt å fjerne observasjoner lørdager og søndager slik at vi kan "matche" datasettene. I en større oppgave vil det være nødvendig å foreta en hypotesetest om prisen for bitcoin i helgene er signifikant forskjellig fra ukedagene. En alternativ løsning kunne vært å omgjøre prisene og aksjekursene til ukentlig data.

Vi har valgt den amerikanske indeksen S&P 500 og den kinesiske indeksen Shanghai Composite. Disse er vide indekser som favner om mange bransjer, vi diversifiserer dermed bort noe usystematisk risiko som ville gitt bransjemessig støy på dataen. 

I vår analyse ønsker vi også å inludere viktige innsatsfaktorer i øknomien, og vi har dermed inkludert olje prisen (WTI) og kapital representert med statobligasjonrentene på de obligasjonene med kortest løpetid, USA 3 month treasury bonds og Kinesiske 1 Year bonds. Disse to rente blir brukt som mål på renten for risikofri kapital i sine respektive marked. Endringe i risikofri rente er viktig for finansmarkedne fordi det inngår i kalkulasjon av avkasningkravet WACC. Hvis renten går opp må avkastningskravet også gå opp. (Langli 2016)   

Dra inn flere prediktorvariabler som olje og statsobligasjonsrenter for å gjennomføre en multippel regresjonsanalyse på aksjeindeksene. SL??? 

### Første blikk/intrykk av bitcoin data

```{r data}
btc <- read_csv("data/BTC_USD Bitfinex Historical Data.csv", 
            col_types = cols(Date = col_date(format = "%b %d, %Y"), 
                                            Price = col_number()))

btc <- btc %>%
  select(Date, Price) %>%
  rename(BTC = "Price")

ggplot(btc, aes(x=Date, y = BTC)) +
  geom_line(color = "blue") +
  labs(y = "BTC / USD")


```

```{r}
summary(btc)

btc %>%
  filter(BTC==0)

btc <- btc %>%
  filter(BTC>0)
```

Ved et kall på summary() av dataen ser vi at minimumsprisen på bitcoin er 0. Ved filtrering for 0 viser det seg at datasettet har prisen 0 fire sammenhengende dager. Vi mener at verdien 0 ikke kan stemme og at dataen dermed er manglende. Datasettet filtreres slik at alle verdier er høyere enn 0. 

```{r}
day_stats <- btc %>%
  group_by(day = weekdays(Date)) %>%
  summarise(mean = mean(BTC), median = median(BTC))

day_stats$day <- factor(day_stats$day, levels = c("mandag", "tirsdag", "onsdag", "torsdag",  "fredag", "lørdag", "søndag")) #nødvendig å spesifisere levels for å hindre alfabetisk rekkefølge.

day_stats

day_stats <- day_stats %>%
  gather(key = stat, value = value, -day)
  
  ggplot(day_stats, aes(x=day, y=value, fill = stat)) +
  geom_bar(stat = "identity", position = "dodge")

### laster inn data fra data mappen, så velger kolonnene vi skal bruke med select, og endrer kolonne navn med rename slik at det er lett å forså ### hvilken kolonne som tilfører hvilken verdi når vi laget et felles datasett. 
    
### s&p 500 - laster inn data, velger kollnnene v
  
  
sp500 <- read_csv("data/^GSPC.csv")

sp500 <- sp500 %>%  
  select(Date, Close) %>%
  rename(SP = "Close")

summary(sp500)


###shanghai

shanghai <- read_csv("data/Shanghai Composite Historical Data.csv", 
            col_types = cols(Date = col_date(format = "%b %d, %Y"), 
                                            Price = col_number()))

shanghai <- shanghai %>%
  select(Date, Price) %>%
  rename(SH = "Price")

summary(shanghai)

# Slår sammen datatsettene med hensyn på dato 

ukedager <- btc %>%
  inner_join(sp500, by = "Date") %>%
  inner_join(shanghai, by = "Date")

# Endrer datsette til long slik at det er klart for å visualiseres 

ukedager_long <- ukedager %>%
  gather(key = index, value = value, -Date, -BTC)

head(ukedager_long)
tail(ukedager_long)

```


##S&P 500 vs BTC og og Shanghai Composite vs BTC

```{r first look, fig.height=10, fig.width= 15}

# Visualiserer dataen med ggplot, med bitcoin på x aksen og verdien til indeksene på y aksen. Bruker facet_wrap for å lage plot ved siden av hverandre slik at det er lett å sammenligne. 

ggplot(ukedager_long, aes(x=BTC, y=value)) +
  geom_point() +
  facet_wrap(~index)

ggplot(ukedager_long, aes(x=BTC, y=value)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~index)

```

For S&P 500: Vi ser at variablene er relaterte, men at forholdet ikke er lineært. En lineær modell vil derfor ikke passe for tidsintervallet. S&P 500 mot log(BTC) gir en mye bedre fit. Vi kan tranformere observasjonene for bitcoin og lage en lineær modell for S&P som utrykk av logaritmeverdiene av bitcoin. I enkelte ggplot-grafer er en svært lav alpha benyttet for å vise den ekstreme overplottingen i nedre venstre hjørne.  

For Shanghai Composite: Ser vi at variablene ikke er relatert i like stor grad. Midtveis i dataen er det en periode hvor de ser ut til å utvikle seg i samme rettning, dette er sannsynligvis en periode i 2014 hvor begge to gikk mye opp samtidig. Dataen ser ikke ut til å passe til en linær modell da den er veldig sprett og ser ikke til å følge et spesiel korrelering.     



```{r, fig.height=10, fig.width= 15}
fit <- lm(SP~log(BTC), data = ukedager)
summary(fit)
plotModel(fit)


mod <- lm(SH~log(BTC), data = ukedager)
summary(mod)
plotModel(mod)
 
ukedager <- ukedager %>%
  mutate(log_BTC = log(BTC))
 
  ukedager_long <- ukedager_long %>%
  mutate(log_BTC = log(BTC))

cor(ukedager$SP, ukedager$log_BTC)
#cor = 0.94
 
ggplot(ukedager_long, aes(x=log_BTC, y=value)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, col = "red") +
  labs(x = "log(BTC)") +
  facet_wrap(~index)

```

Begge indeksene har positive regresjonslinjer. Vi ser at forholdet er sterkere for S&P 500 enn Shangai Composite siden punktene ligger tettere rundt regresjonslinja. Det innebærer at summen av kvadratene blir mindre og at modellene har en bedre fit.

For S&P:
Positiv korrelasjon innebærer at når den ene variabelen øker, øker også den andre. Styrken i forholdet er lik korrelasjonskoeffisienten, som er 0.94. Korrelasjonen er svært sterk og ikke langt unna perfekt. Ved perfekt korrelasjon er koeffisienten?? lik 1.

Hva sier regresjonsmodellen?
R-squared er 0.89. 89% av variasjon i S&P 500 kan forklares av variasjon i log(BTC). For lineære modeller med kun en uavhengig variabel er verdien lik korrelasjonskoeffesienten opphøyet i 2. 

For Shanghai:
Forholdet er ikke like tydelig. En stor mengde observasjoner viser til store endringer i den kinesiske indeksen for de samme verdiene av log(BTC). Observasjonene svekker forholdet for den resterende dataen som følger trenden. I funksjon summary ser vi at R-squared er 0.182 det betyr at modellen har en veldig svak positiv korrelasjon, siden korrelasjon er er oppgitt fra -1 til 1 og beløpet er positivt men nært null.





Vi er interessert i å se hvordan forholdet og korrelasjonen mellom indeksene og log av BTC har utviklet seg over tid. Legger dermed til farge for ulike år for å vise utvikling i korrelasjon over tid.
```{r, fig.height=10, fig.width= 15}
ukedager_years <- ukedager_long %>%
  mutate(year = substr((Date), start = 1, stop = 4))

ukedager_years$year <- as.factor(ukedager_years$year)

ggplot(ukedager_years, aes(x = log_BTC, y = value, col = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black", linetype = "dashed") +
  facet_wrap(~index)

ggplot(ukedager_years, aes(x = log_BTC, y = value, col = year)) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~index)

```

For USA:
I den andre grafen har hvert år fått en regresjonslinje fra egen lineær modell. Fra grafen ser vi at regresjonslinjene har negativt stigningstall i to årstall, 2014 og 2018. Begge de to årene opplevde bitcoin at "bobla sprakk", uten at børsindeksene falt. 

For Kina: 
Vi ser at spredningen i data og avstanden fra regresjnslinjen tyder på veldig stor volatilitet, noe som stemmer overrens med virkeligheten. Shanghai børsen nådde klimax i 2015 og har siden synket over 50%. Stort sette alle datapunktene for 2015 ligger overnfor regresjonslinjen, og i 2018 ser vi at flesteparten av dataen ligger under linjen noe som stemmer overrens med at Bitcoin har falt veldig i verdi i 2018. 


#Glidende korrelasjon
Vi har benyttet 200 dagers glidende korrelasjon. Korrelasjonen på 200 dager flyttes mot høyre. Enhver observasjonen er et resultat av de siste 200 dagene. De 200 første observasjonene "forsvinner" dermed da de ikke har en verdi.

```{r}
rolling_cor <- ukedager %>% 
  mutate(cor_200 = slide2(SP, log_BTC, cor, .size = 200, .align = "right")) %>% 
  unnest() %>%
  na.omit()

mean.cor.sp <- cor(ukedager$SP,ukedager$log_BTC)
mean.200.cor.sp <- mean(rolling_cor$cor_200)
mean.200.cor.sp
mean.200.cor.sp

min.200.cor.sp <- min(rolling_cor$cor_200)
max.200.cor.sp <- max(rolling_cor$cor_200)


ggplot(data = rolling_cor) + geom_line(aes(x = Date, y = cor_200)) + 
  geom_hline(yintercept=mean.cor.sp, linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=mean.200.cor.sp, linetype="dashed", color = "blue", size=1)
```

For USA: Korrelasjonen varierer sterkt i løpet av bitcoins levetid. Med 200-dagers glidende korrelasjon blir utviklingen jevnere enn ved f.eks 100- eller 50- dagers intervaller. Grafen viser at korrelasjonen mellom den amerikanske indeksen og bitcoin har vært svært høy over to lengre perioder (2013 til midten av 2014 og 2017 til midten av 2018). I perioden mellom var den glidende korrelasjonen ned mot -0.7. I denne perioden var det stor nedgang i prisen på bitcoin, mens den amerikanske børsindeksen fortsatte å øke. I andre halvdel av 2018 sank korrelasjonen igjen ned til -0.5. Gjennomsnittet for 200-dagers korrelasjonene er likevel positivt og ligger på 0.42.

Grafen viser den samme utviklingen som de fargerike regresjonslinjene fra forrige figur. I 2014 og 2018 synker korrelasjonen, i 2015 er den positiv, men svak. De resterende årene er korrelasjon positiv og sterk.

```{r}

rolling_cor <- ukedager %>% 
  mutate(cor_200 = slide2(SH, log_BTC, cor, .size = 200, .align = "right")) %>% 
  unnest() %>%
  na.omit()

mean.cor.sh <- cor(ukedager$SH,ukedager$log_BTC)
mean.200.cor.sh <- mean(rolling_cor$cor_200)
mean.cor.sh
mean.200.cor.sh

min.200.cor.sh <- min(rolling_cor$cor_200)
max.200.cor.sh <- max(rolling_cor$cor_200)


ggplot(data = rolling_cor) + geom_line(aes(x = Date, y = cor_200)) + 
  geom_hline(yintercept=mean.cor.sh, linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=mean.200.cor.sh, linetype="dashed", color = "blue", size=1)
```

For Kina:
Den kinesiske glidene korrelasjon skille seg fra den Amerikanske ved at den er mye mer negativ. Dette må nok ses i sammenheng med utviklingen i markede. I 2015 ser vi i at korrelasjon er på nesten -1.  Det er på samme tidspunkt som Shanghai børsen når sin all time high og Bitcoin er på sin bunn etter at 2014 bobblen sprakk.  

Hvordan er den kinesiske glidende korrelasjon?  SL? 
Stemmer den intuitivt med fargelinjene? SL? 
Hvilken situasjon forklarer topp og bunn? SL? 

Den gjennomsnittlige korrelasjonen er høyere enn gjennomsnittet av den 200-dagers glidende korrelasjonen. Dette gjelder både for den amerikanske og kinesiske indeksen.


##Multippel regresjonsmodell:

```{r multiple data}

### Vi lastere inn flere datasett, endrer kolonne til dato. Så reduserer vi dasette ved å selektere de kolonnene vi trenger og endrer navn, begge handlingene gjør vi gjennom tidyverse sin pipe funksjon slik at det blir mer konsist og letter å forså koden. 

### Oil wti 

oilwti <- read_csv("data/Crude Oil WTI Futures Historical Data.csv", 
                   col_types = cols(Date = col_date(format = "%b %d, %Y")))

oilwti <- oilwti %>%
  select(Date, Price) %>%
  rename(oil = "Price")

#### USA 3m Bond rate

usa3m <- read_csv("data/United States 3-Month Bond Yield Historical Data.csv", 
                  col_types = cols(Date = col_date(format = "%b %d, %Y")))

usa3m <- usa3m %>%
  select(Date, Price) %>%
  rename(us3m = "Price")

china_1y <- read_csv("data/China 1-Year Bond Yield Historical Data.csv", 
                      col_types = cols(Date = col_date(format = "%b %d, %Y"))) 

china_1y <- china_1y %>%
  select(Date, Price) %>%
  rename(ch1y = "Price")


#### Felles datasett 

multi <- china_1y %>%
  inner_join(oilwti, by = "Date") %>%
  inner_join(usa3m, by = "Date") %>%
  inner_join(shanghai, by = "Date") %>%
  inner_join(sp500, by = "Date") %>%
  inner_join(btc, by = "Date")


head(multi)

```

##For USA:
```{r, echo = TRUE}
multifit.sp <- lm(formula = SP ~ oil + us3m + log(BTC), data = multi)
summary(multifit.sp)
```


En multippel regresjonsanalyse av S&P 500 med amerikansk oljepris, rente på 3-måneders amerikanske statsobligasjoner og transformerte verdier av bitcoin som uavhengige variabler. R-squared for modellen er 0.94, dette er høyere enn ved bitcoin som eneste faktor. Når vi legger til olje og statsobligasjoner øker prediksjonsverdien til modellen med 0.05 (0.94-0.89).

##Oppsummering av S&P 500 og BTC
S&P 500 er sterkt korrelert med BTC. Transformering av bitcoinprisen til logaritmeverdier viser en sterk og positiv korrelasjon. 

##For Kina:

```{r}

multifit.sh <- lm(formula = SH ~ oil + ch1y + log(BTC), data = multi)
summary(multifit.sh)
```

Hva viser modellen? Endring fra enkel regresjonsmodell (kun BTC)? SL?

Multiple R-squared er mye lavere for det kinesiske markede (0.5979) enn for det amerikanske (0.9438). Detter er sannaynligvis tilfelledigheter siden det kinesiske markedet har hatt negativ utvikling etter 2015 mens det amerikanske og bitcoin har hatt en sammenfallende positiv utviling hvis man ser på perioden under et. 



##Dataens reliabilitet 

Svakheten i dataen skal vi illustrere videre i oppgaven ved å analysere samme data, men over ulike tidshoisonter. Bitcoin dataen er over en relativ kort tidshorisont 2012-2018, og hele perioden sammenfaller med bullmarket i USA etter finanaskrisen, det kan gjøre at dataen kan får en urelatert positiv korrelasjon.   


```{r}
multi_cor  <- multi%>% 
  select(ch1y, oil, us3m, BTC, SP, SH)

res <- cor(multi_cor)
round(res, 2)

corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```


Her ser vi en korrelasjons matrix med finansmarkedene i USA og Kina og viktige innsatsfaktorer i markedene. 

Vi ser at oljeprisen har negative korrelasjon på finansmarkedene både i USA og Kina. Det skjer ved at en økning i pris på en viktig innsatsfaktor (olje) prises inn markede ved å redusere akjskurser siden økt oljepris redusert fri egenkapital hos bedrifter. Aksjer representerer verdien til selskapet etter at sikkret gjeld er betalt. Derfor er fri egenkapital viktig fordi det øker selskapenes muligheter til å øke egenkapitalen eller utbetale utbytte. (Langli, 2016)

For å vurdere om disse dataen er reliable har vi tatt ut bitcoin slik at vi kan øke tidshorisonten vår fra 2012-2018 til 2001-2018 

```{r}

# Her lager vi et nytt datasett men uten bitcoin 

multi_u <- china_1y %>%
  inner_join(oilwti, by = "Date") %>%
  inner_join(usa3m, by = "Date") %>%
  inner_join(shanghai, by = "Date") %>%
  inner_join(sp500, by = "Date")

multi_u_cor  <- multi_u%>% 
  select(ch1y, oil, us3m, SP, SH)

res2 <- cor(multi_u_cor)
round(res, 2)

corrplot(res2, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
 

```

Vi ser her at korrelasjonene er mye svakere når tidshorisonten øker.  Differansen i korrelasjon mellom dataen har vi samlet i en differanse korrelasjon matrix.  

```{r}
# Lager ny matrix av kort tidshorisont dataen uten bitcoin

res3 <- res[c(1, 2, 3, 5, 6), c(1, 2, 3, 5, 6)]

# Trekker fra verdiene i kort tidshorisont matrixen med lang tidshorisont matrixen for å få en differnase matrix

res4 <- res3 - res2

res4
```

Her ser vi differansen i korrelasjoner mellom tidsperiodene 2012-2018 og 2001-2018. Det er spesielt korrelasjon mellom oljeprisen og aksjeindeksene som viser seg å ha stor endring, hvor Shanghai har -1.002 i differanse, og SP500 har -0.5877. 

Differanse matrixen kunne dessverre ikke vises grafisk siden enkelte differanser i korrelasjon var større enn 1  eller -1 og korrelasjoner kan kun utrykkes innenfor det intervallet. 

#Konklusjon 

Ut fra dataen tyder det på at det amrikanske markedet er tetter knyttet opp mot bitcoin. USA er også verdens største øknomi og USAs BNP er 40% større en Kinas. Da er det kanskje ikke så unaturlig at utvillingen i det amerikanske markede påvirker Bitcoin mer enn Kinas.     


##Svakheter/utfordringer

Utfordringen i vår analyse er tidshorisont. Datasette til bitcoin strekker seg tilbake til 2012, fordi det var da bitcoin startet å bli handlet i organiserte marked.   

Sterk korrelasjon er ikke en indikator på årsakssammenhen eller kausalitet.



###Kilder:

Langli J. (2016) Årsregnskapet 10. utg, ISBN/EAN: 9788205494510 Gyldendal Oslo  


- BTC/USD
https://www.bitfinex.com/stats  (Krever bruker for å laste ned data)

- S&P 500

https://www.investing.com/indices/us-spx-500-historical-data

- Oil West texas intermidate 

https://www.investing.com/commodities/crude-oil-historical-data

-Shanghai Composite 

https://www.investing.com/indices/shanghai-composite-historical-data

-USA 3 month treasury bonds 

https://www.investing.com/rates-bonds/u.s.-3-month-bond-yield

-Kina 1 year treasury bond

https://www.investing.com/rates-bonds/china-1-year-bond-yield-historical-data






