---
title: "Project_tidy"
author: "Martin S. Bjørnerem"
date: "9 desember 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(readxl)
library(lubridate)
library(mosaic)
library(tsibble)
```

## Vårt prosjekt: Bitcoin og aksjemarkeder

###Introduksjon
Hva vi ønsker å gjøre, hvordan, hvilke data, innhentingsmetoder, utvikling i oppgaven underveis.


Vi ønsker å undersøke om prisutviklingen på bitcoin påvirker kursene på verdens aksjemarkeder. Vi har hentet daglig data for bitcoin i USD (BTC/USD) og s&p500 så langt bak i tid som mulig. Siden BTC kan kjøpes og selges hele uka, også i helgene, har vi valgt å fjerne observasjoner lørdager og søndager slik at vi kan "matche"" datasettene. En alternativ løsning er ukentlig data. 

### Første blikk/intrykk av bitcoin data

```{r data}
btc <- read_csv("data/BTC_USD Bitfinex Historical Data.csv", 
            col_types = cols(Date = col_date(format = "%b %d, %Y"), 
                                            Price = col_number())) 

btc <- btc %>%
  select(Date, Price) %>%
  rename(BTC = "Price")

summary(btc)

btc %>%
  filter(BTC==0)

btc <- btc %>%
  filter(BTC>0)

day_stats <- btc %>%
  group_by(day = weekdays(Date)) %>%
  summarise(mean = mean(BTC), median = median(BTC))

day_stats$day <- factor(day_stats$day, levels = c("mandag", "tirsdag", "onsdag", "torsdag",  "fredag", "lørdag", "søndag"))
#nødvendig å spesifisere levels for å hindre alfabetisk rekkefølge.

day_stats

day_stats <- day_stats %>%
  gather(key = stat, value = value, -day)
  
  ggplot(day_stats, aes(x=day, y=value, fill = stat)) +
  geom_bar(stat = "identity", position = "dodge")

sp500 <- read_csv("data/^GSPC.csv")

sp500 <- sp500 %>%  
  select(Date, Close) %>%
  rename(SP = "Close")

summary(sp500)

shanghai <- read_csv("data/Shanghai Composite Historical Data.csv", 
            col_types = cols(Date = col_date(format = "%b %d, %Y"), 
                                            Price = col_number()))

shanghai <- shanghai %>%
  select(Date, Price) %>%
  rename(SH = "Price")

summary(shanghai)

weekdays <- btc %>%
  inner_join(sp500, by = "Date") %>%
  inner_join(shanghai, by = "Date")

weekdays_long <- weekdays %>%
  gather(index, verdi, -Date, -BTC)

weekdays_long

```

##S&P 500 og BTC

```{r first look, fig.height=10, fig.width= 15, warning= TRUE}

ggplot(weekdays, aes(x=BTC, y=SP)) +
  geom_point()

ggplot(weekdays, aes(x=BTC, y=SP)) +
  geom_point(alpha = 0.1)

logfit <- lm(SP~log(BTC), data = weekdays)
summary(logfit)
plotModel(logfit)

cor(weekdays$SP, log(weekdays$BTC))
#cor = 0.94

 weekdays <- weekdays %>%
  mutate(log_BTC = log(BTC))
 
  weekdays_long <- weekdays_long %>%
  mutate(log_BTC = log(BTC))
 
ggplot(weekdays, aes(x=log_BTC, y=SP)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, col = "red") +
  labs(x = "log(BTC)")


```

Vi ser at variablene er relaterte, men at forholdet ikke er lineært. En lineær modell vil derfor ikke passe for tidsintervallet. S&P 500 mot log(BTC) gir en mye bedre fit. Vi kan lage en lineær modell for S&P som utrykk av logaritmeverdiene av bitcoin. I enkelte ggplot-grafer er en svært lav alpha benyttet for å vise den ekstreme overplottingen i nedre venstre hjørne.  

Positiv korrelasjon innebærer at når den ene variabelen øker, øker også den andre. Styrken i forholdet er lik korrelasjonskoeffisienten, som er 0.94. Korrelasjonen er svært sterk og ikke langt unna perfekt. Ved perfekt korrelasjon er koeffisienten?? lik 1.

Hva sier regresjonsmodellen?
R-squared er 0.89. 89% av variasjon i S&P 500 kan forklares av variasjon i log(BTC). For lineære modeller med kun en uavhengig variabel er verdien lik korrelasjonskoeffesienten opphøyet i 2. 

Vi er interessert i å se hvordan forholdet og korrelasjonen mellom S&P 500 og log av BTC har utviklet seg over tid. 

```{r}
weekdays_years <- weekdays %>%
  mutate(year = substr((Date), start = 1, stop = 4))

weekdays_years$year <- as.factor(weekdays_years$year)



weekdays_years_l <- weekdays_long %>%
  mutate(year = substr((Date), start = 1, stop = 4))

weekdays_years_l$year <- as.factor(weekdays_years_l$year)

ggplot(weekdays_years, aes(x = log_BTC, y = SP, col = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black", linetype = "dashed")

ggplot(weekdays_years_l, aes(x = log_BTC, y = verdi, col = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black", linetype = "dashed") +
  facet_wrap(~index)

ggplot(weekdays_years, aes(x = log_BTC, y = SP, col = year)) +
  geom_smooth(method = "lm", se = FALSE)


```

Fra grafen ser vi at regresjonslinja har negativt stigningstall i to årstall, 2014 og 2018. Begge de to årene opplevde bitcoin at "bobla sprakk".

#Glidende korrelasjon
Vi har benyttet 200 dagers glidende korrelasjon. Korrelasjonen på 200 dager flyttes mot høyre. Enhver observasjonen er et resultat av de siste 200 dagene. De 200 første observasjonene "forsvinner" dermed da de ikke har en verdi.

```{r}
rolling_cor <- weekdays %>% 
  mutate(cor_200 = slide2(SP, log_BTC, cor, .size = 200, .align = "right")) %>% 
  unnest() %>%
  na.omit()

mean.cor.sp <- cor(weekdays$SP,weekdays$log_BTC)
mean.200.cor.sp <- mean(rolling_cor$cor_200)
mean.cor.sp
mean.200.sp

min.200.cor <- min(rolling_cor$cor_200)
max.200.cor <- max(rolling_cor$cor_200)


ggplot(data = rolling_cor) + geom_line(aes(x = Date, y = cor_200)) + 
  geom_hline(yintercept=mean.cor, linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=mean.200.cor, linetype="dashed", color = "blue", size=1)
```

Korrelasjonen varierer sterkt i løpet av bitcoins levetid. Med 200-dagers glidende korrelasjon blir utviklingen jevnere enn ved f.eks 100- eller 50- dagers intervaller. Grafen viser at korrelasjonen mellom den amerikanske indeksen og bitcoin har vært svært høy over to lengre perioder (2013 til midten av 2014 og 2017 til midten av 2018). I perioden mellom var den glidende korrelasjonen ned mot -0.7. I denne perioden var det stor nedgang i prisen på bitcoin, mens den amerikanske børsindeksen fortsatte å øke. I andre halvdel av 2018 sank korrelasjonen igjen ned til -0.5. Gjennomsnittet for 200-dagers korrelasjonene er likevel positivt og ligger på 0.42.

Grafen viser den samme utviklingen som de fargerike regresjonslinjene fra forrige figur. I 2014 og 2018 synker korrelasjonen, i 2015 er den positiv, men svak. De resterende årene er korrelasjon positiv og sterk.

Den gjennomsnittlige korrelasjonen er høyere enn gjennomsnittet av den 100-dagers glidende korrelasjonen. Hva betyr dette?


##Multippel regresjonsmodell:

```{r multiple data}

### Oil wti 

oilwti <- read_csv("data/Crude Oil WTI  Historical Data.csv", 
                   col_types = cols(Date = col_date(format = "%b %d, %Y")))

oilwti <- oilwti %>%
  select(Date, Price) %>%
  rename(oil = "Price")

#### USA 3m Bond rate

usa3m <- read_csv("data/United States 3-Month Bond Yield Historical Data.csv", 
                  col_types = cols(Date = col_date(format = "%b %d, %Y")))

usa3m <- usa3m %>%
  select(Date, Price) %>%
  rename(us3m = "Price")

china_1y <- read_csv("data/China 1-Year Bond Yield Historical Data.csv", 
                      col_types = cols(Date = col_date(format = "%b %d, %Y"))) 

china_1y <- china_1y %>%
  select(Date, Price) %>%
  rename(ch1y = "Price")


#### Felles datasett 


multi <- china_1y %>%
  inner_join(oilwti, by = "Date") %>%
  inner_join(usa3m, by = "Date") %>%
  inner_join(shanghai, by = "Date") %>%
  inner_join(sp500, by = "Date") %>%
  inner_join(btc, by = "Date")


head(multi)

multifit <- lm(formula = SP ~ oil + us3m + log(BTC), data = multi)
summary(multifit)
```


En multippel regresjonsanalyse av S&P 500 med amerikansk oljepris, rente på 3-måneders amerikanske statsobligasjoner og transformerte verdier av bitcoin som uavhengige variabler. R-squared for modellen er 0.94, dette er høyere enn ved bitcoin som eneste faktor. 

##Oppsummering av S&P 500 og BTC
S&P 500 er sterkt korrelert med BTC. Transformering av bitcoinprisen til logaritmeverdier viser en sterk og positiv korrelasjon. 






```{r shanghai}
#########

ggplot(weekdays, aes(x=BTC, y=SH)) +
  geom_point()

ggplot(weekdays, aes(x=BTC, y=SH)) +
  geom_point(alpha = 0.1)

logfit <- lm(SH~log(BTC), data = weekdays)
summary(logfit)
plotModel(logfit)

cor(weekdays$SH, log(weekdays$BTC))
#cor = 0.94

weekdays <- weekdays %>%
  mutate(log_BTC = log(BTC))

ggplot(weekdays, aes(x=log_BTC, y=SH)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, col = "red") +
  labs(x = "log(BTC)")

```





```{r}
weekdays_years <- weekdays %>%
  mutate(year = substr((Date), start = 1, stop = 4))

weekdays_years$year <- as.factor(weekdays_years$year)

ggplot(weekdays_years, aes(x = log_BTC, y = SH, col = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black", linetype = "dashed")

ggplot(weekdays_years, aes(x = log_BTC, y = SH, col = year)) +
  geom_smooth(method = "lm", se = FALSE)

```




```{r}
rolling_cor <- weekdays %>% 
  mutate(cor_200 = slide2(SH, log_BTC, cor, .size = 200, .align = "right")) %>% 
  unnest() %>%
  na.omit()

mean.cor.sh <- cor(weekdays$SH,weekdays$log_BTC)
mean.200.cor.sh <- mean(rolling_cor$cor_200)
mean.cor.sh
mean.200.cor.sh

min.200.cor.sh <- min(rolling_cor$cor_200)
max.200.cor.sh <- max(rolling_cor$cor_200)

ggplot(data = rolling_cor) + geom_line(aes(x = Date, y = cor_200)) + 
  geom_hline(yintercept=mean.cor, linetype="dashed", color = "red", size=1) +
  geom_hline(yintercept=mean.200.cor, linetype="dashed", color = "blue", size=1)
```




```{r}

multifit.c <- lm(formula = SH ~ oil + ch1y + log(BTC), data = multi)
summary(multifit.c)
```

